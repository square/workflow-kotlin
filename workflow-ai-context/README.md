# Module workflow-ai-context

A Gradle plugin that extracts AI context (skills, `AGENTS.md`) from workflow-kotlin
library JARs into the correct locations for your AI coding agent.

## How It Works

workflow-kotlin publishes AI skills and an `AGENTS.md` guide inside its library JARs
(under `META-INF/com.squareup.workflow1/`). This plugin scans your project's classpath,
discovers those resources, and writes them to your project root — giving your AI agent
version-matched knowledge of the workflow-kotlin APIs.

```
┌─────────────────────────────────────────────────┐
│  Published JARs (Maven Central)                 │
│                                                 │
│  workflow-core.jar                              │
│    META-INF/com.squareup.workflow1/             │
│      AGENTS.md                                  │
│      skills/create-workflow/SKILL.md            │
│      skills/extracting-ai-context/SKILL.md      │
│                                                 │
│  workflow-testing.jar                           │
│    META-INF/com.squareup.workflow1/             │
│      skills/workflow-testing/SKILL.md           │
│      skills/workflow-integration-testing/SKILL.md│
└──────────────────────┬──────────────────────────┘
                       │
          ./gradlew extractAiContext
                       │
                       ▼
┌─────────────────────────────────────────────────┐
│  Your Project Root                              │
│                                                 │
│  AGENTS.md  (merged with your existing content) │
│  .agents/skills/                                │
│    create-workflow/SKILL.md                     │
│    workflow-testing/SKILL.md                    │
│    workflow-integration-testing/SKILL.md        │
│    extracting-ai-context/SKILL.md               │
└─────────────────────────────────────────────────┘
```

## Setup

Apply the plugin in your project's `build.gradle(.kts)`:

```groovy
// build.gradle
plugins {
  id 'com.squareup.workflow1.ai-context' version '<workflow-version>'
}
```

```kotlin
// build.gradle.kts
plugins {
  id("com.squareup.workflow1.ai-context") version "<workflow-version>"
}
```

The plugin requires workflow-kotlin dependencies on your classpath (e.g., `workflow-core`,
`workflow-testing`) — it scans those JARs for bundled AI context.

## Usage

### Extract AI Context

```bash
./gradlew extractAiContext
```

This does two things:

1. **Extracts skills** to `.agents/skills/` — version-matched guides for creating
   workflows, writing tests, and managing AI context
1. **Merges `AGENTS.md`** — injects workflow-kotlin guidance into your project's
   `AGENTS.md` using clearly delimited markers, preserving your existing content

The default output directory (`.agents/skills/`) works out of the box for **Amp, Cursor,
Codex, GitHub Copilot, Gemini CLI, and OpenCode**.

### Preview Mode

See what would be extracted without writing any files:

```bash
./gradlew extractAiContext --preview
```

### Multi-Agent Support

Use `--tools` to extract skills into directories for additional agents:

```bash
# Amp (default) + Claude Code
./gradlew extractAiContext --tools=amp,claude-code

# Writes to both .agents/skills/ AND .claude/skills/
```

Supported agents:

| Agent | Flag | Skills Directory |
|---|---|---|
| Amp, Cursor, Codex, Copilot, Gemini CLI | `amp` (default) | `.agents/skills/` |
| Claude Code | `claude-code` | `.claude/skills/` |
| Goose | `goose` | `.goose/skills/` |
| Windsurf | `windsurf` | `.windsurf/skills/` |
| Roo Code | `roo` | `.roo/skills/` |

Unknown agent names fall back to `.{name}/skills/`.

### Update After a Version Bump

When you update your workflow-kotlin dependency, re-run extraction to get
version-matched skills:

```bash
./gradlew extractAiContext
```

The injection markers in `AGENTS.md` ensure the old content is cleanly replaced.
Skills are overwritten with the new versions.

## Gitignore

Add extracted skill directories to `.gitignore` since they're generated from JARs:

```gitignore
# Extracted AI context (generated by extractAiContext task)
.agents/skills/create-workflow/
.agents/skills/workflow-testing/
.agents/skills/workflow-integration-testing/
.agents/skills/extracting-ai-context/
```

Do **not** gitignore `AGENTS.md` — it contains your project-specific content
alongside the injected workflow-kotlin block.

## What Gets Extracted

### Skills

| Skill | Source JAR | Description |
|---|---|---|
| `create-workflow` | `workflow-core` | Creating StatefulWorkflow and StatelessWorkflow classes |
| `workflow-testing` | `workflow-testing` | Unit testing with testRender / RenderTester |
| `workflow-integration-testing` | `workflow-testing` | Integration testing with renderForTest / WorkflowTurbine |
| `extracting-ai-context` | `workflow-core` | This plugin's own usage guide (self-referential for future re-runs) |

### AGENTS.md

The root workflow-kotlin project guide is merged into your `AGENTS.md` using
injection markers. Your existing content is preserved:

```
<!-- workflow-kotlin-AGENTS-injection:START -->
... workflow-kotlin guidance ...
<!-- workflow-kotlin-AGENTS-injection:END -->
```

## How Publishing Works

Library authors don't need to do anything special — the `published` convention plugin
automatically bundles AI context from each module:

- Each module's `.agents/skills/` directory → bundled into that module's JAR
- Each module's `AGENTS.md` → bundled into that module's JAR
- Root-level `.agents/skills/` and `AGENTS.md` → bundled into `workflow-core`'s JAR

All resources are stored under `META-INF/com.squareup.workflow1/` in the JAR.
