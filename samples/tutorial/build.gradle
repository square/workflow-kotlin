import org.jetbrains.kotlin.gradle.tasks.KotlinCompile
// Top-level build file where you can add configuration options common to all sub-projects/modules.
buildscript {
  def rootProps = new Properties()
  def rootPropsFile = file("../../gradle.properties")
  if (rootPropsFile.exists()) {
    rootPropsFile.withInputStream { rootProps.load(it) }
  }

  ext {
    kotlin_version = '2.3.10'
    // Use the most recent version so we keep the tutorial up-to-date!
    workflow_version = rootProps.getProperty("LAST_PUBLISHED_VERSION_NAME") ?: "1.24.04"

    deps = [
        activityktx: 'androidx.activity:activity-ktx:1.8.2',
        agp: "com.android.tools.build:gradle:8.11.1",
        appcompat: 'androidx.appcompat:appcompat:1.7.0',
        constraintlayout: 'androidx.constraintlayout:constraintlayout:2.1.4',
        kotlin: [
            plugin: "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version",
            stdlib: "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version",
            test: "org.jetbrains.kotlin:kotlin-test-junit:$kotlin_version",
        ],
        material: 'com.google.android.material:material:1.11.0',
        recyclerview: 'androidx.recyclerview:recyclerview:1.3.2',
        viewbinding: 'androidx.databinding:viewbinding:8.1.2',
        viewmodelktx: 'androidx.lifecycle:lifecycle-viewmodel-ktx:2.8.7',
        viewmodelsavedstate: 'androidx.lifecycle:lifecycle-viewmodel-savedstate:2.8.7',
        workflow: [
            core_android: "com.squareup.workflow1:workflow-ui-core-android:$workflow_version",
            testing: "com.squareup.workflow1:workflow-testing-jvm:$workflow_version",
        ],
    ]
  }

  repositories {
    google()
    mavenCentral()
  }
  dependencies {
    classpath deps.agp
    classpath deps.kotlin.plugin

    // NOTE: Do not place your application dependencies here; they belong
    // in the individual module build.gradle files
  }
}

plugins {
  id 'ai-rules-extract'
}

subprojects {
  repositories {
    mavenLocal()
    google()
    mavenCentral()
  }

  tasks.withType(KotlinCompile).configureEach {
    kotlinOptions {
      freeCompilerArgs += '-opt-in=kotlin.RequiresOptIn'
    }
  }

  plugins.withId("org.jetbrains.kotlin.android")  {
    java {
      toolchain {
        languageVersion.set(JavaLanguageVersion.of(17))
      }
    }
  }
}

tasks.register("clean", Delete) {
  delete rootProject.buildDir
}

tasks.register("verifyAiRulesExtraction") {
  dependsOn 'extractAiRules'
  group = 'verification'
  description = 'Verifies that AI rules and skills were correctly extracted from workflow JARs'

  doLast {
    // These are the minimum expected files from workflow-core (always transitively available)
    def expectedRules = [
      '.firebender/rules/workflow-core.mdc',
      '.cursor/rules/workflow-core.mdc',
      '.claude/rules/workflow-core.mdc',
      '.firebender/rules/workflow-testing.mdc',
      '.cursor/rules/workflow-testing.mdc',
      '.claude/rules/workflow-testing.mdc',
    ]

    def expectedSkills = [
      '.firebender/skills/create-workflow/SKILL.md',
      '.cursor/skills/create-workflow/SKILL.md',
      '.claude/skills/create-workflow/SKILL.md',
      '.firebender/skills/workflow-testing/SKILL.md',
      '.cursor/skills/workflow-testing/SKILL.md',
      '.claude/skills/workflow-testing/SKILL.md',
      '.firebender/skills/workflow-integration-testing/SKILL.md',
      '.cursor/skills/workflow-integration-testing/SKILL.md',
      '.claude/skills/workflow-integration-testing/SKILL.md',
    ]
    def expectedAgents = [
      'AGENTS.md',
    ]

    def missing = []

    (expectedRules + expectedSkills + expectedAgents).each { path ->
      def f = file(path)
      if (!f.exists()) {
        missing << path
      } else if (f.text.trim().isEmpty()) {
        missing << "$path (empty)"
      }
    }

    if (!missing.isEmpty()) {
      throw new GradleException(
        "AI rules extraction verification failed. Missing or empty files:\n" +
        missing.collect { "  - $it" }.join('\n')
      )
    }

    println "AI rules extraction verification passed!"
    println "  Rules: ${expectedRules.size} verified"
    println "  Skills: ${expectedSkills.size} verified"
  }
}
